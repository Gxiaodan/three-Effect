<!DOCTYPE html>
<html lang="en">

<head>
    <title>multidoor-cabinet Demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="../../main.css">
</head>

<body>
    <div id="info"></div>

    <script type="module">

        import * as THREE from '../../../build/three.module.js';
        import { GUI } from '../../jsm/libs/dat.gui.module.js';
        import { MTLLoader } from '../../jsm/loaders/MTLLoader.js';
        import { OBJLoader } from '../../jsm/loaders/OBJLoader.js';
        import { OrbitControls } from '../../jsm/controls/OrbitControls.js';

        let container;

        let camera, scene, renderer;

        let controls;

        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;
        var params = {
            light: 0xffffff,
            color: 0xffffff,
            x: 0.1,
            y: 1.0,
            z: 0
        };
        var obj;
        var pointLight
        init();
        animate();


        function init() {

            container = document.createElement('div');
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.z = 5;

            // scene

            scene = new THREE.Scene();

            const size = 50;
            const divisions = 50;
            const gridHelper = new THREE.GridHelper(size, divisions);
            // scene.add(gridHelper);

            var ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
            scene.add(ambientLight);

            pointLight = new THREE.PointLight(0xffffff, 0.8);

            const sphereSize = 0.1;
            const pointLightHelper = new THREE.PointLightHelper(pointLight, sphereSize);
            console.log(pointLightHelper);

            // cube Texture
            var texture = new THREE.TextureLoader().load( "../../img/floor/floor.jpg" ,(texture) => {
                
                var material = new THREE.MeshBasicMaterial({ color: 0xcccccc, map: texture, side: THREE.BackSide });
                var geometry = new THREE.BoxBufferGeometry(20, 20, 20);

                var cube = new THREE.Mesh(geometry, material);
                cube.position.y = 5;
                scene.add(cube);
            });

            // side: THREE.BackSide

            scene.add(pointLightHelper);
            scene.add(pointLight);
            scene.add(camera);

            // model

            var onProgress = function (xhr) {

                if (xhr.lengthComputable) {

                    var percentComplete = xhr.loaded / xhr.total * 100;
                    // console.log(Math.round(percentComplete, 2) + '% downloaded');

                }

            };

            var onError = function () { };

            var manager = new THREE.LoadingManager();
            // manager.addHandler( /\.dds$/i, new DDSLoader() );
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);


            controls = new OrbitControls(camera, renderer.domElement);

            var gui = new GUI();
            gui.addColor(params, 'color').onChange(e => {
                params.color = e;
            })
            gui.addColor(params, 'light').onChange(e => {
                params.light = e;
            })

            gui.add(params, 'x', -2.0, 2.0);
            gui.add(params, 'y', -2.0, 2.0);
            gui.add(params, 'z', -2.0, 2.0);
            new MTLLoader(manager)
                .setPath('../../models/lineAni/')
                .load('multidoor-cabinet.mtl', function (materials) {

                    materials.preload();

                    new OBJLoader(manager)
                        .setMaterials(materials)
                        .setPath('../../models/lineAni/')
                        .load('multidoor-cabinet.obj', function (object) {
                            scene.add(object);
                            obj = object;
                            console.log(obj);
                        }, onProgress, onError);

                });


            window.addEventListener('resize', onWindowResize, false);

        }

        function onWindowResize() {

            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);

        }


        function animate() {

            controls.update()

            requestAnimationFrame(animate);
            render();

        }

        function render() {
            if (obj) {
                obj.children.forEach(child => {
                    child.material.color.set(params.color);
                });
                // console.log(params.color);
                pointLight.color.set(params.light);
                pointLight.position.x = params.x;
                pointLight.position.y = params.y;
                pointLight.position.z = params.z;
            }

            renderer.render(scene, camera);

        }

    </script>

</body>

</html>